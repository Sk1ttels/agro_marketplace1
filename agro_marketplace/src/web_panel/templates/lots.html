{% extends "base.html" %}
{% block title %}Лоти — Agro Admin{% endblock %}
{% block page_title %}Лоти{% endblock %}
{% block page_desc %}Управління торговими оголошеннями{% endblock %}

{% block content %}
<div class="page-bar">
  <div class="filter-tabs">
    <a href="/lots"              class="ftab {% if not status %}active{% endif %}">Всі ({{ rows|length if not status else '—' }})</a>
    <a href="/lots?status=active"  class="ftab {% if status == 'active' %}active{% endif %}"><span class="bdot" style="background:var(--emerald);display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px"></span>Активні</a>
    <a href="/lots?status=pending" class="ftab {% if status == 'pending' %}active{% endif %}"><span class="bdot" style="background:var(--amber);display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px"></span>Очікують</a>
    <a href="/lots?status=closed"  class="ftab {% if status == 'closed' %}active{% endif %}">Закриті</a>
    <a href="/lots?status=deleted" class="ftab {% if status == 'deleted' %}active{% endif %}">Видалені</a>
  </div>
  <div class="page-bar-r">
    <a href="/lots/export" class="btn btn-success btn-sm"><i class="fas fa-download"></i> CSV</a>
  </div>
</div>

{% if rows %}
<div class="lots-grid">
  {% for row in rows %}
  <div class="lot-card">
    <div class="lc-head">
      <div>
        <div class="lc-crop">{{ row['crop'] or 'Культура' }}</div>
        <div style="font-size:12px;color:var(--tm);margin-top:2px">#{{ row['id'] }}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        {% if row['type'] == 'sell' %}
          <span class="badge b-sell"><i class="fas fa-tag" style="font-size:9px"></i> Продаж</span>
        {% else %}
          <span class="badge b-buy"><i class="fas fa-shopping-cart" style="font-size:9px"></i> Купівля</span>
        {% endif %}
        {% if row['status'] == 'active' %}
          <span class="badge b-active"><span class="bdot"></span>Активний</span>
        {% elif row['status'] == 'pending' %}
          <span class="badge b-pending"><span class="bdot"></span>Очікує</span>
        {% elif row['status'] == 'deleted' %}
          <span class="badge b-closed">Видалено</span>
        {% else %}
          <span class="badge b-closed">{{ row['status'] or 'Закрито' }}</span>
        {% endif %}
      </div>
    </div>

    <div class="lc-body">
      <div class="lc-price">
        {% if row['price'] %}
          {{ "%.0f"|format(row['price']|float) }} <span>грн/т</span>
        {% else %}
          <span style="font-size:14px;color:var(--tm)">Договірна</span>
        {% endif %}
      </div>
      <div class="lc-row"><i class="fas fa-map-marker-alt"></i> {{ row['region'] or '—' }}</div>
      <div class="lc-row"><i class="fas fa-weight-hanging"></i> {% if 'volume' in cols %}{{ row['volume'] }}{% elif 'volume_tons' in cols %}{{ row['volume_tons'] }}{% else %}—{% endif %} т</div>
      {% if row['location'] %}<div class="lc-row"><i class="fas fa-warehouse"></i> {{ row['location'] }}</div>{% endif %}
      {% if row['comment'] %}<div class="lc-row" style="margin-top:6px"><i class="fas fa-comment"></i> <em style="color:var(--tm)">{{ row['comment'][:60] }}{% if row['comment']|length > 60 %}…{% endif %}</em></div>{% endif %}
    </div>

    <div class="lc-foot">
      <span style="font-size:12px;color:var(--tm)"><i class="far fa-calendar" style="margin-right:4px"></i>{{ (row['created_at'] or '—')[:10] }}</span>
      <div class="act-g">
        <a href="/lots/{{ row['id'] }}" class="act p" title="Деталі"><i class="fas fa-eye"></i></a>
        {% if row['status'] == 'active' %}
        <form method="POST" action="/lots/{{ row['id'] }}/close" style="display:inline">
          <button type="submit" class="act d" title="Закрити лот"><i class="fas fa-times"></i></button>
        </form>
        {% elif row['status'] != 'deleted' %}
        <form method="POST" action="/lots/{{ row['id'] }}/activate" style="display:inline">
          <button type="submit" class="act s" title="Активувати"><i class="fas fa-check"></i></button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div style="padding:12px 0;font-size:13px;color:var(--tm);text-align:center">
  Показано {{ rows|length }} лотів{% if status %} зі статусом «{{ status }}»{% endif %}
</div>

{% else %}
<div class="card">
  <div class="empty">
    <div class="empty-icon"><i class="fas fa-box-open"></i></div>
    <div class="empty-title">Лотів не знайдено</div>
    <div class="empty-desc">
      {% if status %}Немає лотів зі статусом «{{ status }}»
      {% else %}Лоти з'являться після першої публікації через Telegram Bot{% endif %}
    </div>
    {% if status %}
    <a href="/lots" class="btn btn-secondary mt-8"><i class="fas fa-arrow-left"></i> Всі лоти</a>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}
