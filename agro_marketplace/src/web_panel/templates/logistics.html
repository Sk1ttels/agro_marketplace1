{% extends "base.html" %}
{% block title %}–õ–æ–≥—ñ—Å—Ç–∏–∫–∞ ‚Äî Agro Admin{% endblock %}
{% block page_title %}üöö –õ–æ–≥—ñ—Å—Ç–∏–∫–∞{% endblock %}
{% block page_desc %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º —Ç–∞ –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è{% endblock %}

{% block content %}

<!-- Stats Row -->
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
  <div class="card" style="padding:20px;text-align:center">
    <div style="font-size:28px;font-weight:700;color:var(--accent)">{{ stats.total_vehicles }}</div>
    <div style="font-size:12px;color:var(--tm);margin-top:4px">–í—Å—å–æ–≥–æ –∞–≤—Ç–æ</div>
  </div>
  <div class="card" style="padding:20px;text-align:center">
    <div style="font-size:28px;font-weight:700;color:#22c55e">{{ stats.available_vehicles }}</div>
    <div style="font-size:12px;color:var(--tm);margin-top:4px">–î–æ—Å—Ç—É–ø–Ω–∏—Ö –∞–≤—Ç–æ</div>
  </div>
  <div class="card" style="padding:20px;text-align:center">
    <div style="font-size:28px;font-weight:700;color:#f59e0b">{{ stats.total_shipments }}</div>
    <div style="font-size:12px;color:var(--tm);margin-top:4px">–í—Å—å–æ–≥–æ –∑–∞—è–≤–æ–∫</div>
  </div>
  <div class="card" style="padding:20px;text-align:center">
    <div style="font-size:28px;font-weight:700;color:#6366f1">{{ stats.active_shipments }}</div>
    <div style="font-size:12px;color:var(--tm);margin-top:4px">–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫</div>
  </div>
</div>

<!-- Tabs -->
<div class="card" style="margin-bottom:16px;padding:0">
  <div style="display:flex;border-bottom:1px solid var(--border)">
    <a href="/logistics?tab=shipments{% if q %}&q={{ q }}{% endif %}" 
       class="tab-btn {% if tab=='shipments' %}active{% endif %}"
       style="padding:14px 24px;border:none;background:none;cursor:pointer;font-size:14px;font-weight:600;color:{% if tab=='shipments' %}var(--accent){% else %}var(--tm){% endif %};border-bottom:{% if tab=='shipments' %}2px solid var(--accent){% else %}none{% endif %};text-decoration:none;display:block">
      üì¶ –ó–∞—è–≤–∫–∏ <span style="background:{% if tab=='shipments' %}var(--accent){% else %}#e5e7eb{% endif %};color:{% if tab=='shipments' %}#fff{% else %}#6b7280{% endif %};padding:2px 8px;border-radius:12px;font-size:11px">{{ stats.total_shipments }}</span>
    </a>
    <a href="/logistics?tab=vehicles{% if q %}&q={{ q }}{% endif %}"
       class="tab-btn {% if tab=='vehicles' %}active{% endif %}"
       style="padding:14px 24px;border:none;background:none;cursor:pointer;font-size:14px;font-weight:600;color:{% if tab=='vehicles' %}var(--accent){% else %}var(--tm){% endif %};border-bottom:{% if tab=='vehicles' %}2px solid var(--accent){% else %}none{% endif %};text-decoration:none;display:block">
      üöõ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç <span style="background:{% if tab=='vehicles' %}var(--accent){% else %}#e5e7eb{% endif %};color:{% if tab=='vehicles' %}#fff{% else %}#6b7280{% endif %};padding:2px 8px;border-radius:12px;font-size:11px">{{ stats.total_vehicles }}</span>
    </a>
  </div>
</div>

<!-- Search & Filter -->
<div class="card" style="margin-bottom:16px">
  <form method="get" action="/logistics" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <input type="hidden" name="tab" value="{{ tab }}">
    <div style="position:relative;flex:1;min-width:200px">
      <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--tm);font-size:13px"></i>
      <input name="q" value="{{ q }}" class="input" placeholder="–ü–æ—à—É–∫ –∑–∞ —Ä–µ–≥—ñ–æ–Ω–æ–º, –≤–∞–Ω—Ç–∞–∂–µ–º..." style="padding-left:36px;width:100%">
    </div>
    {% if tab == 'shipments' %}
    <select name="status" class="input" style="min-width:140px">
      <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="active" {% if status_filter=='active' %}selected{% endif %}>‚úÖ –ê–∫—Ç–∏–≤–Ω—ñ</option>
      <option value="done" {% if status_filter=='done' %}selected{% endif %}>‚úîÔ∏è –í–∏–∫–æ–Ω–∞–Ω—ñ</option>
      <option value="cancelled" {% if status_filter=='cancelled' %}selected{% endif %}>‚ùå –°–∫–∞—Å–æ–≤–∞–Ω—ñ</option>
    </select>
    {% else %}
    <select name="status" class="input" style="min-width:140px">
      <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="available" {% if status_filter=='available' %}selected{% endif %}>‚úÖ –î–æ—Å—Ç—É–ø–Ω—ñ</option>
      <option value="busy" {% if status_filter=='busy' %}selected{% endif %}>üî¥ –ó–∞–π–Ω—è—Ç—ñ</option>
    </select>
    {% endif %}
    <button class="btn" type="submit"><i class="fas fa-filter"></i> –§—ñ–ª—å—Ç—Ä</button>
    {% if q or status_filter %}
    <a href="/logistics?tab={{ tab }}" class="btn" style="background:#f3f4f6;color:#374151"><i class="fas fa-times"></i> –°–∫–∏–Ω—É—Ç–∏</a>
    {% endif %}
  </form>
</div>

<!-- ============ SHIPMENTS TAB ============ -->
{% if tab == 'shipments' %}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <h3 style="margin:0;font-size:16px">üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è</h3>
    <span style="font-size:12px;color:var(--tm)">–ü–æ–∫–∞–∑–∞–Ω–æ: {{ shipments|length }}</span>
  </div>
  {% if not shipments %}
    <div class="empty" style="padding:40px;text-align:center">
      <div style="font-size:48px;margin-bottom:12px">üì≠</div>
      <div style="color:var(--tm)">–ó–∞—è–≤–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
    </div>
  {% else %}
  <div style="overflow-x:auto">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>–í–∞–Ω—Ç–∞–∂</th>
          <th>–û–±—Å—è–≥</th>
          <th>–ú–∞—Ä—à—Ä—É—Ç</th>
          <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–∞—Ç–∞</th>
          <th style="min-width:140px">–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        {% for s in shipments %}
        <tr>
          <td><code>#{{ s.id }}</code></td>
          <td><b>{{ s.cargo_type }}</b></td>
          <td>{{ s.volume_tons }} —Ç</td>
          <td style="white-space:nowrap">
            <span style="color:#6366f1">{{ s.from_region }}</span>
            <span style="color:var(--tm)"> ‚Üí </span>
            <span style="color:#059669">{{ s.to_region }}</span>
            {% if s.from_location or s.to_location %}
            <br><small style="color:var(--tm)">{{ s.from_location or '' }}{% if s.from_location and s.to_location %} ‚Üí {% endif %}{{ s.to_location or '' }}</small>
            {% endif %}
          </td>
          <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ s.comment or '‚Äî' }}</td>
          <td>
            <span class="badge badge-{% if s.status=='active' %}success{% elif s.status=='done' %}info{% else %}danger{% endif %}">
              {% if s.status=='active' %}‚úÖ –ê–∫—Ç–∏–≤–Ω–∞{% elif s.status=='done' %}‚úîÔ∏è –í–∏–∫–æ–Ω–∞–Ω–∞{% else %}‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–∞{% endif %}
            </span>
          </td>
          <td style="white-space:nowrap;font-size:12px;color:var(--tm)">{{ (s.created_at or '')[:10] }}</td>
          <td>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              {% if s.status == 'active' %}
              <form method="post" action="/logistics/shipment/{{ s.id }}/status" style="display:inline">
                <input type="hidden" name="status" value="done">
                <button class="btn btn-sm" type="submit" style="background:#22c55e;color:#fff" title="–í–∏–∫–æ–Ω–∞–Ω–æ">‚úîÔ∏è</button>
              </form>
              <form method="post" action="/logistics/shipment/{{ s.id }}/status" style="display:inline">
                <input type="hidden" name="status" value="cancelled">
                <button class="btn btn-sm btn-danger" type="submit" title="–°–∫–∞—Å—É–≤–∞—Ç–∏" onclick="return confirm('–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞—è–≤–∫—É?')">‚úñ</button>
              </form>
              {% endif %}
              <a class="btn btn-sm" href="/logistics/shipment/{{ s.id }}/edit">‚úèÔ∏è</a>
              <form method="post" action="/logistics/shipment/{{ s.id }}/delete" style="display:inline" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞—è–≤–∫—É #{{ s.id }}?')">
                <button class="btn btn-sm btn-danger" type="submit">üóë</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<!-- ============ VEHICLES TAB ============ -->
{% else %}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <h3 style="margin:0;font-size:16px">üöõ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–π –ø–∞—Ä–∫</h3>
    <span style="font-size:12px;color:var(--tm)">–ü–æ–∫–∞–∑–∞–Ω–æ: {{ vehicles|length }}</span>
  </div>
  {% if not vehicles %}
    <div class="empty" style="padding:40px;text-align:center">
      <div style="font-size:48px;margin-bottom:12px">üöó</div>
      <div style="color:var(--tm)">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
    </div>
  {% else %}
  <div style="overflow-x:auto">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>–¢–∏–ø</th>
          <th>–í–∞–Ω—Ç–∞–∂–æ–ø—ñ–¥–π–æ–º–Ω—ñ—Å—Ç—å</th>
          <th>–ö-—Å—Ç—å –∞–≤—Ç–æ</th>
          <th>–ë–∞–∑–∞</th>
          <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–∞—Ç–∞</th>
          <th style="min-width:120px">–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        {% for v in vehicles %}
        <tr>
          <td><code>#{{ v.id }}</code></td>
          <td>
            {% if v.body_type == 'grain' %}üåæ –ó–µ—Ä–Ω–æ–≤–æ–∑
            {% elif v.body_type == 'tipper' %}ü™® –°–∞–º–æ—Å–∫–∏–¥
            {% elif v.body_type == 'tarp' %}üßµ –¢–µ–Ω—Ç
            {% else %}{{ v.body_type }}{% endif %}
          </td>
          <td><b>{{ v.capacity_tons }} —Ç</b></td>
          <td>{{ v.count_units }} —à—Ç</td>
          <td>{{ v.base_region }}</td>
          <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ v.comment or '‚Äî' }}</td>
          <td>
            <span class="badge badge-{% if v.status=='available' %}success{% else %}danger{% endif %}">
              {% if v.status=='available' %}‚úÖ –î–æ—Å—Ç—É–ø–Ω–∏–π{% else %}üî¥ –ó–∞–π–Ω—è—Ç–∏–π{% endif %}
            </span>
          </td>
          <td style="white-space:nowrap;font-size:12px;color:var(--tm)">{{ (v.created_at or '')[:10] }}</td>
          <td>
            <div style="display:flex;gap:6px">
              {% if v.status == 'available' %}
              <form method="post" action="/logistics/vehicle/{{ v.id }}/status" style="display:inline">
                <input type="hidden" name="status" value="busy">
                <button class="btn btn-sm" style="background:#f59e0b;color:#fff" type="submit" title="–ó–∞–π–Ω—è—Ç–∏">üî¥</button>
              </form>
              {% else %}
              <form method="post" action="/logistics/vehicle/{{ v.id }}/status" style="display:inline">
                <input type="hidden" name="status" value="available">
                <button class="btn btn-sm" style="background:#22c55e;color:#fff" type="submit" title="–ó–≤—ñ–ª—å–Ω–∏—Ç–∏">‚úÖ</button>
              </form>
              {% endif %}
              <a class="btn btn-sm" href="/logistics/vehicle/{{ v.id }}/edit">‚úèÔ∏è</a>
              <form method="post" action="/logistics/vehicle/{{ v.id }}/delete" style="display:inline" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∞–≤—Ç–æ #{{ v.id }}?')">
                <button class="btn btn-sm btn-danger" type="submit">üóë</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endif %}

<style>
.badge { display:inline-block; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.badge-success { background:#d1fae5; color:#065f46; }
.badge-danger { background:#fee2e2; color:#991b1b; }
.badge-info { background:#dbeafe; color:#1e40af; }
</style>
{% endblock %}
