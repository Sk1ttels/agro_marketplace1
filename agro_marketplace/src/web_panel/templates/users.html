{% extends "base.html" %}
{% block title %}Користувачі — Agro Admin{% endblock %}
{% block page_title %}Користувачі{% endblock %}
{% block page_desc %}Управління учасниками платформи{% endblock %}

{% block content %}
<div class="page-bar">
  <form method="GET" action="/users" style="display:flex;gap:8px;align-items:center;flex:1">
    <div class="search-wrap">
      <i class="si fas fa-search"></i>
      <input type="text" name="q" class="search-inp" placeholder="Пошук за ім'ям, ID, @username…" value="{{ q }}">
    </div>
    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Знайти</button>
    {% if q %}<a href="/users" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i> Скинути</a>{% endif %}
  </form>
  <div class="page-bar-r">
    <a href="/users/export" class="btn btn-success btn-sm"><i class="fas fa-download"></i> CSV</a>
  </div>
</div>

<!-- Summary pills -->
<div style="display:flex;gap:10px;flex-wrap:wrap">
  <div style="padding:6px 14px;background:var(--s1);border:1px solid var(--border);border-radius:8px;font-size:12.5px;color:var(--ts)">
    <span style="color:var(--tp);font-weight:700">{{ rows|length }}</span> знайдено
  </div>
  <div style="padding:6px 14px;background:var(--s1);border:1px solid var(--border);border-radius:8px;font-size:12.5px;color:var(--ts)">
    <span style="color:var(--emerald);font-weight:700">{{ rows|selectattr('is_banned','equalto',0)|list|length }}</span> активних
  </div>
  <div style="padding:6px 14px;background:var(--s1);border:1px solid var(--border);border-radius:8px;font-size:12.5px;color:var(--ts)">
    <span style="color:var(--rose);font-weight:700">{{ rows|selectattr('is_banned','equalto',1)|list|length }}</span> забанено
  </div>
</div>

<div class="card">
  <div class="table-wrap">
    {% if rows %}
    <table class="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Користувач</th>
          <th>Telegram ID</th>
          <th>Username</th>
          <th>Роль</th>
          <th>Статус</th>
          <th>Реєстрація</th>
          <th class="text-end">Дії</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td><span class="text-muted" style="font-size:12px">#{{ row['id'] }}</span></td>
          <td>
            <div class="user-row">
              <div class="avatar">{{ (row['full_name'] or row['username'] or '?')[0].upper() }}</div>
              <div>
                <div class="un">{{ row['full_name'] or 'Без імені' }}</div>
                {% if row['phone'] %}<div class="us">{{ row['phone'] }}</div>{% endif %}
              </div>
            </div>
          </td>
          <td><code style="font-size:12px;color:var(--ts);background:var(--s2);padding:2px 6px;border-radius:4px">{{ row['tg_id'] or row['telegram_id'] or '—' }}</code></td>
          <td>
            {% if row['username'] %}
            <a href="https://t.me/{{ row['username'] }}" target="_blank" style="color:var(--sky);font-size:13px">@{{ row['username'] }} <i class="fas fa-external-link-alt" style="font-size:10px"></i></a>
            {% else %}<span class="text-muted">—</span>{% endif %}
          </td>
          <td>
            {% if row['role'] == 'admin' %}
              <span class="badge b-pending">admin</span>
            {% else %}
              <span style="font-size:12px;color:var(--tm)">user</span>
            {% endif %}
          </td>
          <td>
            {% if row['is_banned'] %}
              <span class="badge b-banned"><span class="bdot"></span>Забанено</span>
            {% else %}
              <span class="badge b-active"><span class="bdot"></span>Активний</span>
            {% endif %}
          </td>
          <td><span style="font-size:12px;color:var(--tm)">{{ (row['created_at'] or '—')[:10] }}</span></td>
          <td class="text-end">
            <div class="act-g" style="justify-content:flex-end">
              <a href="/users/{{ row['id'] }}" class="act p" title="Деталі"><i class="fas fa-eye"></i></a>
              {% if row['is_banned'] %}
              <form method="POST" action="/users/{{ row['id'] }}/unban" style="display:inline">
                <button type="submit" class="act s" title="Розблокувати"><i class="fas fa-unlock"></i></button>
              </form>
              {% else %}
              <form method="POST" action="/users/{{ row['id'] }}/ban" style="display:inline"
                    onsubmit="return confirm('Забанити цього користувача?')">
                <button type="submit" class="act d" title="Заблокувати"><i class="fas fa-ban"></i></button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty">
      <div class="empty-icon"><i class="fas fa-users-slash"></i></div>
      <div class="empty-title">Користувачів не знайдено</div>
      <div class="empty-desc">{% if q %}Змініть параметри пошуку{% else %}Першого користувача додасте через Telegram Bot{% endif %}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
