<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Agro Admin{% endblock %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}?v=4">
</head>
<body>

{% if current_user.is_authenticated %}
<div class="app-wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon">üåæ</div>
      <div>
        <div class="brand-name">Agro Market</div>
        <div class="brand-sub">Admin Panel</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">–ì–æ–ª–æ–≤–Ω–µ</div>
      <a href="/dashboard" class="nav-link {% if request.path.startswith('/dashboard') or request.path == '/' %}active{% endif %}">
        <i class="ni fas fa-chart-line"></i> –î–∞—à–±–æ—Ä–¥
      </a>
      <a href="/users" class="nav-link {% if request.path.startswith('/users') %}active{% endif %}">
        <i class="ni fas fa-users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
      </a>
      <a href="/lots" class="nav-link {% if request.path.startswith('/lots') %}active{% endif %}">
        <i class="ni fas fa-box"></i> –õ–æ—Ç–∏
      </a>
      <a href="/logistics" class="nav-link {% if request.path.startswith('/logistics') %}active{% endif %}">
        <i class="ni fas fa-truck"></i> –õ–æ–≥—ñ—Å—Ç–∏–∫–∞
      </a>

      <div class="nav-section" style="margin-top:16px">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
      <a href="/advertisements" class="nav-link {% if request.path.startswith('/advertisements') %}active{% endif %}">
        <i class="ni fas fa-bullhorn"></i> –†–µ–∫–ª–∞–º–∞
      </a>
      <a href="/contacts" class="nav-link {% if request.path.startswith('/contacts') %}active{% endif %}">
        <i class="ni fas fa-address-book"></i> –ö–æ–Ω—Ç–∞–∫—Ç–∏
      </a>

      <div class="nav-section" style="margin-top:16px">–°–∏—Å—Ç–µ–º–∞</div>
      <a href="/sync" class="nav-link {% if request.path.startswith('/sync') %}active{% endif %}">
        <i class="ni fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
        <span class="nav-badge" id="syncBadge" style="display:none">0</span>
      </a>
      <a href="/settings" class="nav-link {% if request.path.startswith('/settings') %}active{% endif %}">
        <i class="ni fas fa-cog"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-card">
        <div class="u-avatar">{{ current_user.id[0].upper() }}</div>
        <div style="flex:1;min-width:0">
          <div class="u-name">{{ current_user.id }}</div>
          <div class="u-role">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</div>
        </div>
        <a href="/logout" class="logout-btn" title="–í–∏–π—Ç–∏"><i class="fas fa-sign-out-alt"></i></a>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <button class="topbar-btn mobile-menu-btn" id="mobileToggle" title="–ú–µ–Ω—é" style="display:none">
        <i class="fas fa-bars"></i>
      </button>
      <div style="min-width:0">
        <div class="topbar-title">{% block page_title %}{% endblock %}</div>
        <div class="topbar-desc mobile-hide">{% block page_desc %}{% endblock %}</div>
      </div>
      <div class="topbar-right">
        <div class="sync-pill mobile-hide" id="syncPill">
          <div class="sync-dot" id="syncDot"></div>
          <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ</span>
        </div>
        <button class="topbar-btn" onclick="location.reload()" title="–û–Ω–æ–≤–∏—Ç–∏"><i class="fas fa-sync-alt"></i></button>
        <a href="/logout" class="topbar-btn mobile-only" title="–í–∏–π—Ç–∏" style="color:#fb7185"><i class="fas fa-sign-out-alt"></i></a>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content fade-in">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-stack">
          {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }}">
            <i class="fas fa-{% if cat == 'success' %}check-circle{% elif cat == 'danger' %}exclamation-circle{% elif cat == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ msg }}
            <button class="alert-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>
  </div>
</div>

<script>
// Mobile overlay
const overlay = document.createElement('div');
overlay.id = 'sidebarOverlay';
overlay.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99;backdrop-filter:blur(2px)';
document.body.appendChild(overlay);

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  overlay.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  overlay.style.display = 'none';
  document.body.style.overflow = '';
}

overlay.addEventListener('click', closeSidebar);

document.addEventListener('click', e => {
  if (e.target.closest('#mobileToggle')) {
    const isOpen = document.getElementById('sidebar').classList.contains('open');
    isOpen ? closeSidebar() : openSidebar();
  }
});

// Close sidebar on nav link click (mobile)
document.querySelectorAll('.nav-link').forEach(l => {
  l.addEventListener('click', () => {
    if (window.innerWidth <= 900) closeSidebar();
  });
});

// Show/hide mobile button
function checkMobile() {
  const btn = document.querySelector('.mobile-menu-btn');
  if (!btn) return;
  btn.style.display = window.innerWidth <= 900 ? 'flex' : 'none';
}
checkMobile();
window.addEventListener('resize', checkMobile);

// ‚îÄ‚îÄ Auto-refresh sync status ‚îÄ‚îÄ
async function checkSync() {
  try {
    const r = await fetch('/sync');
    const h = await r.text();
    const m = h.match(/sync-count['"]\s*>\s*(\d+)/);
    const count = m ? parseInt(m[1]) : 0;
    const dot  = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    const badge = document.getElementById('syncBadge');
    if (count > 0) {
      dot.className = 'sync-dot loading';
      text.textContent = count + ' –ø–æ–¥—ñ–π –æ—á—ñ–∫—É—é—Ç—å';
      if(badge){badge.textContent = count; badge.style.display = 'inline-block';}
    } else {
      dot.className = 'sync-dot';
      text.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ';
      if(badge) badge.style.display = 'none';
    }
  } catch(e) {
    const dot = document.getElementById('syncDot');
    if(dot) dot.className = 'sync-dot err';
  }
}
checkSync();
setInterval(checkSync, 8000);
</script>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-bottom-nav">
  <div class="mbn-items">
    <a href="/dashboard" class="mbn-item {% if request.path.startswith('/dashboard') or request.path == '/' %}active{% endif %}">
      <i class="fas fa-chart-line"></i>
      <span>–î–∞—à–±–æ—Ä–¥</span>
      <div class="mbn-dot"></div>
    </a>
    <a href="/users" class="mbn-item {% if request.path.startswith('/users') %}active{% endif %}">
      <i class="fas fa-users"></i>
      <span>–Æ–∑–µ—Ä–∏</span>
      <div class="mbn-dot"></div>
    </a>
    <a href="/lots" class="mbn-item {% if request.path.startswith('/lots') %}active{% endif %}">
      <i class="fas fa-box"></i>
      <span>–õ–æ—Ç–∏</span>
      <div class="mbn-dot"></div>
    </a>
    <a href="/logistics" class="mbn-item {% if request.path.startswith('/logistics') %}active{% endif %}">
      <i class="fas fa-truck"></i>
      <span>–õ–æ–≥—ñ—Å—Ç.</span>
      <div class="mbn-dot"></div>
    </a>
    <button class="mbn-item" id="mobileToggle">
      <i class="fas fa-bars"></i>
      <span>–ë—ñ–ª—å—à–µ</span>
      <div class="mbn-dot"></div>
    </button>
  </div>
</nav>


{% else %}
{% block login_content %}{% endblock %}
{% endif %}

</body>
</html>
