<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Agro Admin{% endblock %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}?v=4">
</head>
<body>

{% if current_user.is_authenticated %}
<div class="app-wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon">üåæ</div>
      <div>
        <div class="brand-name">Agro Market</div>
        <div class="brand-sub">Admin Panel</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">–ì–æ–ª–æ–≤–Ω–µ</div>
      <a href="/dashboard" class="nav-link {% if request.path.startswith('/dashboard') or request.path == '/' %}active{% endif %}">
        <i class="ni fas fa-chart-line"></i> –î–∞—à–±–æ—Ä–¥
      </a>
      <a href="/users" class="nav-link {% if request.path.startswith('/users') %}active{% endif %}">
        <i class="ni fas fa-users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
      </a>
      <a href="/lots" class="nav-link {% if request.path.startswith('/lots') %}active{% endif %}">
        <i class="ni fas fa-box"></i> –õ–æ—Ç–∏
      </a>

      <div class="nav-section" style="margin-top:16px">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
      <a href="/advertisements" class="nav-link {% if request.path.startswith('/advertisements') %}active{% endif %}">
        <i class="ni fas fa-bullhorn"></i> –†–µ–∫–ª–∞–º–∞
      </a>
      <a href="/contacts" class="nav-link {% if request.path.startswith('/contacts') %}active{% endif %}">
        <i class="ni fas fa-address-book"></i> –ö–æ–Ω—Ç–∞–∫—Ç–∏
      </a>

      <div class="nav-section" style="margin-top:16px">–°–∏—Å—Ç–µ–º–∞</div>
      <a href="/sync" class="nav-link {% if request.path.startswith('/sync') %}active{% endif %}">
        <i class="ni fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
        <span class="nav-badge" id="syncBadge" style="display:none">0</span>
      </a>
      <a href="/settings" class="nav-link {% if request.path.startswith('/settings') %}active{% endif %}">
        <i class="ni fas fa-cog"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-card">
        <div class="u-avatar">{{ current_user.id[0].upper() }}</div>
        <div style="flex:1;min-width:0">
          <div class="u-name">{{ current_user.id }}</div>
          <div class="u-role">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</div>
        </div>
        <a href="/logout" class="logout-btn" title="–í–∏–π—Ç–∏"><i class="fas fa-sign-out-alt"></i></a>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <div>
        <div class="topbar-title">{% block page_title %}{% endblock %}</div>
        <div class="topbar-desc">{% block page_desc %}{% endblock %}</div>
      </div>
      <div class="topbar-right">
        <div class="sync-pill" id="syncPill">
          <div class="sync-dot" id="syncDot"></div>
          <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ</span>
        </div>
        <button class="topbar-btn" onclick="location.reload()" title="–û–Ω–æ–≤–∏—Ç–∏"><i class="fas fa-sync-alt"></i></button>
        <a href="/api/db-check" target="_blank" class="topbar-btn" title="DB Info"><i class="fas fa-database"></i></a>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content fade-in">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert-stack">
          {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }}">
            <i class="fas fa-{% if cat == 'success' %}check-circle{% elif cat == 'danger' %}exclamation-circle{% elif cat == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ msg }}
            <button class="alert-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Auto-refresh sync status ‚îÄ‚îÄ
async function checkSync() {
  try {
    const r = await fetch('/sync');
    const h = await r.text();
    const m = h.match(/sync-count['"]\s*>\s*(\d+)/);
    const count = m ? parseInt(m[1]) : 0;
    const dot  = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    const badge = document.getElementById('syncBadge');
    if (count > 0) {
      dot.className = 'sync-dot loading';
      text.textContent = count + ' –ø–æ–¥—ñ–π –æ—á—ñ–∫—É—é—Ç—å';
      badge.textContent = count;
      badge.style.display = 'inline-block';
    } else {
      dot.className = 'sync-dot';
      text.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ';
      badge.style.display = 'none';
    }
  } catch(e) {
    const dot = document.getElementById('syncDot');
    if(dot) { dot.className = 'sync-dot err'; }
  }
}
checkSync();
setInterval(checkSync, 8000);

// Mobile sidebar toggle
document.addEventListener('click', e => {
  if(e.target.closest('#mobileToggle')) {
    document.getElementById('sidebar').classList.toggle('open');
  }
});
</script>

{% else %}
{% block login_content %}{% endblock %}
{% endif %}

</body>
</html>
