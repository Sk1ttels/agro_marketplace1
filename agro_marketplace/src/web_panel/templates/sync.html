{% extends "base.html" %}
{% block title %}Синхронізація — Agro Admin{% endblock %}
{% block page_title %}Синхронізація{% endblock %}
{% block page_desc %}Статус обміну даними між панеллю та ботом{% endblock %}

{% block content %}
<div class="stats-grid">
  <div class="stat-card amber">
    <div class="stat-icon"><i class="fas fa-clock"></i></div>
    <div>
      <div class="stat-label">Очікують обробки</div>
      <div class="stat-value sync-count">{{ unprocessed_events|length }}</div>
      <div class="stat-sub">необроблених подій</div>
    </div>
  </div>
  <div class="stat-card emerald">
    <div class="stat-icon"><i class="fas fa-check-double"></i></div>
    <div>
      <div class="stat-label">Оброблено</div>
      <div class="stat-value">{{ total_processed }}</div>
      <div class="stat-sub">всього подій</div>
    </div>
  </div>
  <div class="stat-card sky">
    <div class="stat-icon"><i class="fas fa-users"></i></div>
    <div>
      <div class="stat-label">Юзерів у БД</div>
      <div class="stat-value">{{ stats.users_count }}</div>
      <div class="stat-sub">зареєстровано</div>
    </div>
  </div>
  <div class="stat-card rose">
    <div class="stat-icon"><i class="fas fa-box"></i></div>
    <div>
      <div class="stat-label">Лотів у БД</div>
      <div class="stat-value">{{ stats.lots_count }}</div>
      <div class="stat-sub">всього лотів</div>
    </div>
  </div>
</div>

<div class="grid-2">
  <!-- Events -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-list" style="color:var(--amber)"></i> Останні події</div>
      <button class="btn btn-secondary btn-sm" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Оновити</button>
      {% if unprocessed_events %}
      <form method="POST" action="/sync/clear" style="display:inline" onsubmit="return confirm('Очистити всі необроблені події?')">
        <button type="submit" class="btn btn-sm" style="background:rgba(251,113,133,0.1);color:var(--rose);border:1px solid rgba(251,113,133,0.3)">
          <i class="fas fa-trash"></i> Очистити
        </button>
      </form>
      {% endif %}
    </div>
    <div class="card-body">
      {% if unprocessed_events %}
      <div class="sync-events">
        {% for event in unprocessed_events %}
        <div class="se-item">
          <span class="se-type">{{ event.event_type }}</span>
          <span style="font-size:13px;color:var(--ts)">
            {% if event.data.telegram_id %}tg:{{ event.data.telegram_id }}{% endif %}
            {% if event.data.lot_id %}lot:#{{ event.data.lot_id }}{% endif %}
          </span>
          <span class="se-time">{{ (event.timestamp or '')[:16] }}</span>
          <span class="badge b-pending" style="margin-left:8px;flex-shrink:0">Pending</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty" style="padding:32px 0">
        <div class="empty-icon"><i class="fas fa-check-circle" style="color:var(--emerald)"></i></div>
        <div class="empty-title" style="color:var(--emerald-l)">Все синхронізовано</div>
        <div class="empty-desc">Необроблених подій немає</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- How it works -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-info-circle" style="color:var(--sky)"></i> Як працює синхронізація</div>
    </div>
    <div class="card-body" style="display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:32px;height:32px;border-radius:8px;background:rgba(245,158,11,0.1);color:var(--amber);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">1</div>
        <div>
          <div style="font-size:13.5px;font-weight:500;color:var(--tp);margin-bottom:2px">Подія у панелі</div>
          <div style="font-size:12.5px;color:var(--tm)">Бан, розбан, зміна статусу лота записується у sync_events.json</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:32px;height:32px;border-radius:8px;background:rgba(16,185,129,0.1);color:var(--emerald);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">2</div>
        <div>
          <div style="font-size:13.5px;font-weight:500;color:var(--tp);margin-bottom:2px">Бот перевіряє кожні 2с</div>
          <div style="font-size:12.5px;color:var(--tm)">SyncEventProcessor читає файл і обробляє нові події</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:32px;height:32px;border-radius:8px;background:rgba(14,165,233,0.1);color:var(--sky);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">3</div>
        <div>
          <div style="font-size:13.5px;font-weight:500;color:var(--tp);margin-bottom:2px">Сповіщення в Telegram</div>
          <div style="font-size:12.5px;color:var(--tm)">Користувач отримує повідомлення в реальному часі</div>
        </div>
      </div>
      <div class="divider"></div>
      <div style="font-size:12px;color:var(--tm);margin-bottom:8px">Типи подій:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <span class="badge b-banned"><code style="font-size:10px">user_banned</code></span>
        <span class="badge b-active"><code style="font-size:10px">user_unbanned</code></span>
        <span class="badge b-pending"><code style="font-size:10px">lot_status_changed</code></span>
        <span class="badge b-closed"><code style="font-size:10px">settings_changed</code></span>
      </div>
    </div>
  </div>
</div>
{% endblock %}
