{% extends "base.html" %}
{% block title %}–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á #{{ user['id'] }} ‚Äî Agro Admin{% endblock %}
{% block page_title %}–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á #{{ user['id'] }}{% endblock %}
{% block page_desc %}–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è{% endblock %}

{% block content %}
<div style="margin-bottom:16px">
  <a href="/users" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="detail-grid" style="display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start">
  <div style="display:flex;flex-direction:column;gap:16px">
    <!-- Profile -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-user" style="color:var(--amber)"></i> –ü—Ä–æ—Ñ—ñ–ª—å</div>
        {% if user['is_banned'] %}
          <span class="badge b-banned"><span class="bdot"></span>–ó–∞–±–∞–Ω–µ–Ω–æ</span>
        {% else %}
          <span class="badge b-active"><span class="bdot"></span>–ê–∫—Ç–∏–≤–Ω–∏–π</span>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="kv-list">
          <div class="kv-row"><span class="kv-key">ID</span><span class="kv-val">#{{ user['id'] }}</span></div>
          <div class="kv-row"><span class="kv-key">Telegram ID</span>
            <code style="font-size:12px;color:var(--ts);background:var(--s2);padding:2px 8px;border-radius:4px">{{ user['tg_id'] or user['telegram_id'] or '‚Äî' }}</code>
          </div>
          <div class="kv-row"><span class="kv-key">–Ü–º'—è</span><span class="kv-val">{{ user['full_name'] or '‚Äî' }}</span></div>
          <div class="kv-row"><span class="kv-key">Username</span>
            <span class="kv-val">
              {% if user['username'] %}
                <a href="https://t.me/{{ user['username'] }}" target="_blank" style="color:var(--sky)">@{{ user['username'] }}</a>
              {% else %}‚Äî{% endif %}
            </span>
          </div>
          <div class="kv-row"><span class="kv-key">–¢–µ–ª–µ—Ñ–æ–Ω</span><span class="kv-val">{{ user['phone'] or '‚Äî' }}</span></div>
          <div class="kv-row"><span class="kv-key">–ö–æ–º–ø–∞–Ω—ñ—è</span><span class="kv-val">{{ user['company'] or '‚Äî' }}</span></div>
          <div class="kv-row"><span class="kv-key">–†–µ–≥—ñ–æ–Ω</span><span class="kv-val">{{ user['region'] or '‚Äî' }}</span></div>
          <div class="kv-row"><span class="kv-key">–†–æ–ª—å</span>
            <span class="badge {% if user['role'] == 'admin' %}b-pending{% else %}b-closed{% endif %}">{{ user['role'] or 'user' }}</span>
          </div>
          <div class="kv-row"><span class="kv-key">–ü—ñ–¥–ø–∏—Å–∫–∞</span><span class="kv-val">{{ user['subscription_plan'] or 'free' }}</span></div>
          <div class="kv-row"><span class="kv-key">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</span><span class="kv-val" style="font-size:12px">{{ user['created_at'] or '‚Äî' }}</span></div>
        </div>
      </div>
    </div>

    <!-- Lots -->
    {% if lots %}
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-box" style="color:var(--sky)"></i> –õ–æ—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</div>
        <span class="badge b-closed">{{ lots|length }}</span>
      </div>
      <div class="table-wrap">
        <table class="tbl">
          <thead><tr><th>#</th><th>–ö—É–ª—å—Ç—É—Ä–∞</th><th>–¢–∏–ø</th><th>–û–±'—î–º</th><th>–¶—ñ–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead>
          <tbody>
            {% for lot in lots %}
            <tr>
              <td><span class="text-muted" style="font-size:12px">#{{ lot['id'] }}</span></td>
              <td class="strong">{{ lot['crop'] or '‚Äî' }}</td>
              <td>{% if lot['type']=='sell' %}<span class="badge b-sell">–ü—Ä–æ–¥–∞–∂</span>{% else %}<span class="badge b-buy">–ö—É–ø—ñ–≤–ª—è</span>{% endif %}</td>
              <td>{{ lot['volume'] or lot['volume_tons'] or '‚Äî' }} —Ç</td>
              <td>{{ ("%.0f"|format(lot['price']|float)) + ' –≥—Ä–Ω' if lot['price'] else '‚Äî' }}</td>
              <td>
                {% if lot['status']=='active' %}<span class="badge b-active"><span class="bdot"></span>–ê–∫—Ç–∏–≤–Ω–∏–π</span>
                {% elif lot['status']=='pending' %}<span class="badge b-pending">–û—á—ñ–∫—É—î</span>
                {% else %}<span class="badge b-closed">{{ lot['status'] }}</span>{% endif %}
              </td>
              <td><a href="/lots/{{ lot['id'] }}" class="act p"><i class="fas fa-eye"></i></a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right column: actions -->
  <div style="display:flex;flex-direction:column;gap:16px">
    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-tools" style="color:var(--ts)"></i> –î—ñ—ó</div></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:8px">
        {% if user['is_banned'] %}
        <form method="POST" action="/users/{{ user['id'] }}/unban">
          <button type="submit" class="btn btn-success" style="width:100%;justify-content:center">
            <i class="fas fa-unlock"></i> –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏
          </button>
        </form>
        {% else %}
        <form method="POST" action="/users/{{ user['id'] }}/ban" onsubmit="return confirm('–ó–∞–±–∞–Ω–∏—Ç–∏?')">
          <button type="submit" class="btn btn-danger" style="width:100%;justify-content:center">
            <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏
          </button>
        </form>
        {% endif %}
        <div class="divider" style="margin:4px 0"></div>
        <form method="POST" action="/users/{{ user['id'] }}/set_subscription">
          <div style="display:flex;gap:6px">
            <select name="plan" class="form-control" style="flex:1;padding:6px 10px;font-size:13px">
              <option value="free" {% if (user['subscription_plan'] or 'free') == 'free' %}selected{% endif %}>üì¶ Free</option>
              <option value="basic" {% if user['subscription_plan'] == 'basic' %}selected{% endif %}>‚≠ê Basic</option>
              <option value="premium" {% if user['subscription_plan'] == 'premium' %}selected{% endif %}>üíé Premium</option>
              <option value="business" {% if user['subscription_plan'] == 'business' %}selected{% endif %}>üëë Business</option>
            </select>
            <button type="submit" class="btn btn-primary btn-sm" title="–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </form>
        {% if user['username'] %}
        <a href="https://t.me/{{ user['username'] }}" target="_blank" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fab fa-telegram"></i> –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤ Telegram
        </a>
        {% elif user['tg_id'] or user['telegram_id'] %}
        <a href="tg://user?id={{ user['tg_id'] or user['telegram_id'] }}" target="_blank" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fab fa-telegram"></i> –ù–∞–ø–∏—Å–∞—Ç–∏ –≤ Telegram
        </a>
        {% endif %}
        <a href="/users" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fas fa-arrow-left"></i> –î–æ —Å–ø–∏—Å–∫—É
        </a>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-chart-bar" style="color:var(--amber)"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div>
      <div class="card-body">
        <div class="kv-list">
          <div class="kv-row"><span class="kv-key">–í—Å—å–æ–≥–æ –ª–æ—Ç—ñ–≤</span><span class="kv-val strong">{{ lots|length }}</span></div>
          <div class="kv-row"><span class="kv-key">–ê–∫—Ç–∏–≤–Ω–∏—Ö</span><span class="kv-val" style="color:var(--emerald)">{{ lots|selectattr('status','equalto','active')|list|length }}</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
