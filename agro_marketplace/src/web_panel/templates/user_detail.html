{% extends "base.html" %}
{% block title %}Користувач #{{ user['id'] }} — Agro Admin{% endblock %}
{% block page_title %}Користувач #{{ user['id'] }}{% endblock %}
{% block page_desc %}Детальна інформація{% endblock %}

{% block content %}
<div style="margin-bottom:16px">
  <a href="/users" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Назад до списку</a>
</div>

<div class="detail-grid" style="display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start">
  <div style="display:flex;flex-direction:column;gap:16px">
    <!-- Profile -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-user" style="color:var(--amber)"></i> Профіль</div>
        {% if user['is_banned'] %}
          <span class="badge b-banned"><span class="bdot"></span>Забанено</span>
        {% else %}
          <span class="badge b-active"><span class="bdot"></span>Активний</span>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="kv-list">
          <div class="kv-row"><span class="kv-key">ID</span><span class="kv-val">#{{ user['id'] }}</span></div>
          <div class="kv-row"><span class="kv-key">Telegram ID</span>
            <code style="font-size:12px;color:var(--ts);background:var(--s2);padding:2px 8px;border-radius:4px">{{ user['tg_id'] or user['telegram_id'] or '—' }}</code>
          </div>
          <div class="kv-row"><span class="kv-key">Ім'я</span><span class="kv-val">{{ user['full_name'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Username</span>
            <span class="kv-val">
              {% if user['username'] %}
                <a href="https://t.me/{{ user['username'] }}" target="_blank" style="color:var(--sky)">@{{ user['username'] }}</a>
              {% else %}—{% endif %}
            </span>
          </div>
          <div class="kv-row"><span class="kv-key">Телефон</span><span class="kv-val">{{ user['phone'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Компанія</span><span class="kv-val">{{ user['company'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Регіон</span><span class="kv-val">{{ user['region'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Роль</span>
            <span class="badge {% if user['role'] == 'admin' %}b-pending{% else %}b-closed{% endif %}">{{ user['role'] or 'user' }}</span>
          </div>
          <div class="kv-row"><span class="kv-key">Підписка</span><span class="kv-val">{{ user['subscription_plan'] or 'free' }}</span></div>
          <div class="kv-row"><span class="kv-key">Реєстрація</span><span class="kv-val" style="font-size:12px">{{ user['created_at'] or '—' }}</span></div>
        </div>
      </div>
    </div>

    <!-- Lots -->
    {% if lots %}
    <div class="card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-box" style="color:var(--sky)"></i> Лоти користувача</div>
        <span class="badge b-closed">{{ lots|length }}</span>
      </div>
      <div class="table-wrap">
        <table class="tbl">
          <thead><tr><th>#</th><th>Культура</th><th>Тип</th><th>Об'єм</th><th>Ціна</th><th>Статус</th><th></th></tr></thead>
          <tbody>
            {% for lot in lots %}
            <tr>
              <td><span class="text-muted" style="font-size:12px">#{{ lot['id'] }}</span></td>
              <td class="strong">{{ lot['crop'] or '—' }}</td>
              <td>{% if lot['type']=='sell' %}<span class="badge b-sell">Продаж</span>{% else %}<span class="badge b-buy">Купівля</span>{% endif %}</td>
              <td>{{ lot['volume'] or lot['volume_tons'] or '—' }} т</td>
              <td>{{ ("%.0f"|format(lot['price']|float)) + ' грн' if lot['price'] else '—' }}</td>
              <td>
                {% if lot['status']=='active' %}<span class="badge b-active"><span class="bdot"></span>Активний</span>
                {% elif lot['status']=='pending' %}<span class="badge b-pending">Очікує</span>
                {% else %}<span class="badge b-closed">{{ lot['status'] }}</span>{% endif %}
              </td>
              <td><a href="/lots/{{ lot['id'] }}" class="act p"><i class="fas fa-eye"></i></a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right column: actions -->
  <div style="display:flex;flex-direction:column;gap:16px">
    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-tools" style="color:var(--ts)"></i> Дії</div></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:8px">
        {% if user['is_banned'] %}
        <form method="POST" action="/users/{{ user['id'] }}/unban">
          <button type="submit" class="btn btn-success" style="width:100%;justify-content:center">
            <i class="fas fa-unlock"></i> Розблокувати
          </button>
        </form>
        {% else %}
        <form method="POST" action="/users/{{ user['id'] }}/ban" onsubmit="return confirm('Забанити?')">
          <button type="submit" class="btn btn-danger" style="width:100%;justify-content:center">
            <i class="fas fa-ban"></i> Заблокувати
          </button>
        </form>
        {% endif %}
        {% if user['username'] %}
        <a href="https://t.me/{{ user['username'] }}" target="_blank" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fab fa-telegram"></i> Відкрити в Telegram
        </a>
        {% endif %}
        <a href="/users" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fas fa-arrow-left"></i> До списку
        </a>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-chart-bar" style="color:var(--amber)"></i> Статистика</div></div>
      <div class="card-body">
        <div class="kv-list">
          <div class="kv-row"><span class="kv-key">Всього лотів</span><span class="kv-val strong">{{ lots|length }}</span></div>
          <div class="kv-row"><span class="kv-key">Активних</span><span class="kv-val" style="color:var(--emerald)">{{ lots|selectattr('status','equalto','active')|list|length }}</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
