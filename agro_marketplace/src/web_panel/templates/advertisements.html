{% extends "base.html" %}
{% block title %}Реклама — Agro Admin{% endblock %}
{% block page_title %}Реклама{% endblock %}
{% block page_desc %}Управління оголошеннями в Telegram Bot{% endblock %}

{% block content %}
<!-- Create form -->
<div class="card">
  <div class="card-header">
    <div class="card-title"><i class="fas fa-plus" style="color:var(--emerald)"></i> Нове оголошення</div>
    <button class="btn btn-secondary btn-sm" onclick="toggleForm()"><i class="fas fa-chevron-down" id="formIcon"></i></button>
  </div>
  <div id="adForm" style="display:none">
    <form method="POST" action="/advertisements/create">
      <div class="card-body" style="display:flex;flex-direction:column;gap:14px">
        <div class="settings-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-heading"></i> Назва</label>
            <input type="text" name="title" class="form-control" placeholder="Назва оголошення" required>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-tag"></i> Тип</label>
            <select name="type" class="form-control">
              <option value="text">Текст</option>
              <option value="image">Зображення</option>
              <option value="button">З кнопкою</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-align-left"></i> Текст оголошення</label>
          <textarea name="content" class="form-control" rows="3" placeholder="Текст що побачить користувач в Telegram…" required style="resize:vertical"></textarea>
        </div>
        <div class="settings-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-link"></i> URL зображення</label>
            <input type="url" name="image_url" class="form-control" placeholder="https://…">
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-mouse-pointer"></i> Текст кнопки</label>
            <input type="text" name="button_text" class="form-control" placeholder="Дізнатися більше">
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-external-link-alt"></i> URL кнопки</label>
            <input type="url" name="button_url" class="form-control" placeholder="https://…">
          </div>
        </div>
        <div class="settings-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:center">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-redo"></i> Частота показу (кожні N дій)</label>
            <input type="number" name="show_frequency" class="form-control" value="3" min="1" max="100">
          </div>
          <div class="toggle-wrap" style="padding-top:20px">
            <div><div class="tg-label">Активне</div><div class="tg-hint">Показувати зараз</div></div>
            <label class="toggle">
              <input type="checkbox" name="is_active" checked>
              <span class="toggle-track"></span>
            </label>
          </div>
        </div>
      </div>
      <div class="card-footer" style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn btn-secondary" onclick="toggleForm()">Скасувати</button>
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Створити</button>
      </div>
    </form>
  </div>
</div>

{% if ads %}
<div class="ads-grid">
  {% for ad in ads %}
  <div class="ad-card">
    <div class="ad-head">
      <div>
        <div class="ad-title">{{ ad['title'] }}</div>
        <span class="badge {% if ad['is_active'] %}b-active{% else %}b-closed{% endif %}" style="margin-top:4px">
          <span class="bdot"></span>{% if ad['is_active'] %}Активне{% else %}Вимкнено{% endif %}
        </span>
      </div>
      <span class="badge b-closed" style="font-size:10px">{{ ad['type'] }}</span>
    </div>
    <div class="ad-body">
      <div style="color:var(--ts);font-size:13px;line-height:1.5">{{ ad['content'][:120] }}{% if ad['content']|length > 120 %}…{% endif %}</div>
      <div style="margin-top:10px;display:flex;gap:12px;font-size:12px;color:var(--tm)">
        <span><i class="fas fa-eye"></i> {{ ad['views_count'] or 0 }} показів</span>
        <span><i class="fas fa-mouse-pointer"></i> {{ ad['clicks_count'] or 0 }} кліків</span>
        <span><i class="fas fa-redo"></i> кожні {{ ad['show_frequency'] }}</span>
      </div>
    </div>
    <div class="ad-foot">
      <span style="font-size:11.5px;color:var(--tm)">{{ (ad['created_at'] or '—')[:10] }}</span>
      <div class="act-g">
        <button type="button" class="act p" title="Редагувати" onclick="openEditModal({{ ad['id'] }}, {{ ad|tojson }})">
          <i class="fas fa-edit"></i>
        </button>
        <form method="POST" action="/advertisements/{{ ad['id'] }}/toggle" style="display:inline">
          <button type="submit" class="act {% if ad['is_active'] %}d{% else %}s{% endif %}" title="{% if ad['is_active'] %}Вимкнути{% else %}Увімкнути{% endif %}">
            <i class="fas fa-{% if ad['is_active'] %}pause{% else %}play{% endif %}"></i>
          </button>
        </form>
        <form method="POST" action="/advertisements/{{ ad['id'] }}/delete" style="display:inline"
              onsubmit="return confirm('Видалити це оголошення?')">
          <button type="submit" class="act d" title="Видалити"><i class="fas fa-trash"></i></button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="card">
  <div class="empty">
    <div class="empty-icon"><i class="fas fa-bullhorn"></i></div>
    <div class="empty-title">Оголошень ще немає</div>
    <div class="empty-desc">Створіть перше оголошення — воно буде автоматично показуватись в боті</div>
  </div>
</div>
{% endif %}

<script>
function toggleForm() {
  const f = document.getElementById('adForm');
  const i = document.getElementById('formIcon');
  const visible = f.style.display !== 'none';
  f.style.display = visible ? 'none' : 'block';
  i.className = visible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
}

function openEditModal(id, ad) {
  document.getElementById('editAdId').value = id;
  document.getElementById('editTitle').value = ad.title || '';
  document.getElementById('editType').value = ad.type || 'text';
  document.getElementById('editContent').value = ad.content || '';
  document.getElementById('editImageUrl').value = ad.image_url || '';
  document.getElementById('editButtonText').value = ad.button_text || '';
  document.getElementById('editButtonUrl').value = ad.button_url || '';
  document.getElementById('editFrequency').value = ad.show_frequency || 3;
  document.getElementById('editIsActive').checked = !!ad.is_active;
  document.getElementById('editForm').action = '/advertisements/' + id + '/edit';
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

window.onclick = function(e) {
  const m = document.getElementById('editModal');
  if (e.target === m) closeEditModal();
}
</script>

<!-- Edit Modal -->
<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
  <div class="card" style="width:min(600px,95vw);max-height:90vh;overflow-y:auto;margin:0">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-edit" style="color:var(--sky)"></i> Редагувати оголошення</div>
      <button type="button" class="btn btn-secondary btn-sm" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
    </div>
    <form id="editForm" method="POST">
      <input type="hidden" id="editAdId" name="ad_id">
      <div class="card-body" style="display:flex;flex-direction:column;gap:14px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div class="form-group">
            <label class="form-label">Назва</label>
            <input type="text" id="editTitle" name="title" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Тип</label>
            <select id="editType" name="type" class="form-control">
              <option value="text">Текст</option>
              <option value="image">Зображення</option>
              <option value="button">З кнопкою</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Текст оголошення</label>
          <textarea id="editContent" name="content" class="form-control" rows="3" required style="resize:vertical"></textarea>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label">URL зображення</label>
            <input type="url" id="editImageUrl" name="image_url" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">Текст кнопки</label>
            <input type="text" id="editButtonText" name="button_text" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">URL кнопки</label>
            <input type="url" id="editButtonUrl" name="button_url" class="form-control">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:center">
          <div class="form-group">
            <label class="form-label">Частота (кожні N дій)</label>
            <input type="number" id="editFrequency" name="show_frequency" class="form-control" min="1" max="100">
          </div>
          <div class="toggle-wrap" style="padding-top:20px">
            <div><div class="tg-label">Активне</div></div>
            <label class="toggle">
              <input type="checkbox" id="editIsActive" name="is_active">
              <span class="toggle-track"></span>
            </label>
          </div>
        </div>
      </div>
      <div class="card-footer" style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Скасувати</button>
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Зберегти</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
