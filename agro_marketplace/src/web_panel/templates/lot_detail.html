{% extends "base.html" %}
{% block title %}Лот #{{ lot['id'] }} — Agro Admin{% endblock %}
{% block page_title %}Лот #{{ lot['id'] }}{% endblock %}
{% block page_desc %}{{ lot['crop'] or 'Деталі лота' }}{% endblock %}

{% block content %}
<div style="margin-bottom:16px">
  <a href="/lots" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Назад до лотів</a>
</div>

<div class="detail-grid" style="display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start">
  <div style="display:flex;flex-direction:column;gap:16px">
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-seedling" style="color:var(--emerald)"></i> {{ lot['crop'] or 'Культура' }}
          {% if lot['type']=='sell' %}<span class="badge b-sell" style="margin-left:4px">Продаж</span>{% else %}<span class="badge b-buy" style="margin-left:4px">Купівля</span>{% endif %}
        </div>
        {% if lot['status']=='active' %}<span class="badge b-active"><span class="bdot"></span>Активний</span>
        {% elif lot['status']=='pending' %}<span class="badge b-pending"><span class="bdot"></span>Очікує</span>
        {% else %}<span class="badge b-closed">{{ lot['status'] }}</span>{% endif %}
      </div>
      <div class="card-body">
        <div class="kv-list">
          <div class="kv-row"><span class="kv-key">ID лота</span><span class="kv-val">#{{ lot['id'] }}</span></div>
          <div class="kv-row"><span class="kv-key">Культура</span><span class="kv-val strong">{{ lot['crop'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Тип</span><span class="kv-val">{{ 'Продаж' if lot['type']=='sell' else 'Купівля' }}</span></div>
          <div class="kv-row">
            <span class="kv-key">Ціна</span>
            <span class="kv-val" style="color:var(--amber);font-size:18px;font-family:'Outfit',sans-serif;font-weight:700">
              {{ ("%.0f"|format(lot['price']|float)) + ' грн/т' if lot['price'] else 'Договірна' }}
            </span>
          </div>
          <div class="kv-row"><span class="kv-key">Об'єм</span><span class="kv-val">{% if 'volume' in cols %}{{ lot['volume'] }}{% elif 'volume_tons' in cols %}{{ lot['volume_tons'] }}{% else %}—{% endif %} т</span></div>
          <div class="kv-row"><span class="kv-key">Регіон</span><span class="kv-val">{{ lot['region'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Місце</span><span class="kv-val">{{ lot['location'] or '—' }}</span></div>
          {% if lot['comment'] %}
          <div class="kv-row" style="align-items:flex-start;flex-direction:column;gap:6px">
            <span class="kv-key">Коментар</span>
            <span style="font-size:13.5px;color:var(--ts);line-height:1.5">{{ lot['comment'] }}</span>
          </div>
          {% endif %}
          <div class="kv-row"><span class="kv-key">Статус</span><span class="kv-val">{{ lot['status'] or '—' }}</span></div>
          <div class="kv-row"><span class="kv-key">Створено</span><span class="kv-val" style="font-size:12px">{{ lot['created_at'] or '—' }}</span></div>
        </div>
      </div>
    </div>
  </div>

  <div style="display:flex;flex-direction:column;gap:16px">
    <!-- Owner -->
    {% if owner %}
    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-user" style="color:var(--amber)"></i> Власник</div></div>
      <div class="card-body">
        <div class="user-row" style="margin-bottom:12px">
          <div class="avatar">{{ (owner['full_name'] or '?')[0].upper() }}</div>
          <div>
            <div class="un">{{ owner['full_name'] or 'Без імені' }}</div>
            {% if owner['username'] %}
            <a href="https://t.me/{{ owner['username'] }}" target="_blank" style="font-size:12px;color:var(--sky)">@{{ owner['username'] }}</a>
            {% endif %}
          </div>
        </div>
        <a href="/users/{{ owner['id'] }}" class="btn btn-secondary btn-sm" style="width:100%;justify-content:center">
          <i class="fas fa-user"></i> Профіль
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="card">
      <div class="card-header"><div class="card-title"><i class="fas fa-tools" style="color:var(--ts)"></i> Дії</div></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:8px">
        {% if lot['status'] == 'active' %}
        <form method="POST" action="/lots/{{ lot['id'] }}/close">
          <button type="submit" class="btn btn-danger" style="width:100%;justify-content:center">
            <i class="fas fa-times-circle"></i> Закрити лот
          </button>
        </form>
        {% else %}
        <form method="POST" action="/lots/{{ lot['id'] }}/activate">
          <button type="submit" class="btn btn-success" style="width:100%;justify-content:center">
            <i class="fas fa-check-circle"></i> Активувати
          </button>
        </form>
        {% endif %}

        <form method="POST" action="/lots/{{ lot['id'] }}/set_status" style="display:flex;gap:8px">
          <select name="status" class="form-control" style="flex:1">
            <option value="active">active</option>
            <option value="pending">pending</option>
            <option value="closed">closed</option>
            <option value="deleted">deleted</option>
          </select>
          <button type="submit" class="btn btn-secondary"><i class="fas fa-save"></i></button>
        </form>

        <a href="/lots" class="btn btn-secondary" style="width:100%;justify-content:center">
          <i class="fas fa-arrow-left"></i> До лотів
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
